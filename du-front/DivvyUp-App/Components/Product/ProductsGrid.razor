@using DivvyUp_Shared.Dto

<RadzenDialog />

<RadzenDataGrid @ref="@Grid"
                Data="@Products"
                TItem="ProductDto"
                AllowSorting="true"
                AllowAlternatingRows="true"
                FilterMode="FilterMode.Simple"
                AllowFiltering="true"
                LogicalFilterOperator="LogicalFilterOperator.Or"
                AllowPaging="true"
                PagerAlwaysVisible="true"
                PageSize="5"
                PageSizeOptions="@PageSizeOptions"
                PagerHorizontalAlign="HorizontalAlign.Center"
                ShowPagingSummary="true"
                EditMode="DataGridEditMode.Single"
                GridLines="DataGridGridLines.Both">
    <HeaderTemplate>
        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Dodaj produkt" Click="InsertRow" />
        <RadzenButton ButtonStyle="ButtonStyle.Light" Icon="add_circle" Text="Odśwież" Click="LoadGrid" />
        <RadzenButton ButtonStyle="ButtonStyle.Secondary" Icon="receipt_long" Text="Powrót do rachunków" Click="@(() => { Navigation.NavigateTo("/receipt"); } )" />
    </HeaderTemplate>
    <Columns>
        <RadzenDataGridColumn Title="Zarządzanie" Width="12%" TextAlign="TextAlign.Center" Frozen="true">
            <Template Context="product">
                @*<RadzenButton class="button" Icon="edit" ButtonStyle="ButtonStyle.Secondary" Click="@((args) => EditRow(product))" />*@
                <RadzenButton class="button" Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="@((args) => RemoveRow(product.id))" />
            </Template>
            <EditTemplate Context="product">
                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Click="@((args) => SaveRow(product))" />
                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Click="@((args) => CancelEdit(product))" />
            </EditTemplate>
            <FilterTemplate>
                <RadzenButton class="button" Icon="filter_alt_off" ButtonStyle="ButtonStyle.Dark" Click="@(args => { Grid.Reset(); })" />
            </FilterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ProductDto.settled)" Title="Rozliczono" Width="7%" TextAlign="TextAlign.Center" Frozen="true">
            <Template Context="product">
                <RadzenCheckBox class="button" @bind-Value="@product.settled" Change="@(async (bool Check) => await ChangeSettled(product.id, product.settled))" />
            </Template>
            <EditTemplate Context="product">
                <RadzenCheckBox style="opacity: 0.6; " class="button" Value="@product.settled" ReadOnly="true" />
            </EditTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ProductDto.divisible)" Title="Podzielność" Width="7%" TextAlign="TextAlign.Center" Frozen="true">
            <Template Context="product">
                <RadzenCheckBox class="button" @bind-Value="@product.divisible" ReadOnly="true" />
            </Template>
            <EditTemplate Context="product">
                <RadzenCheckBox class="button" @bind-Value="@product.divisible" />
            </EditTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ProductDto.name)" Title="Nazwa" Width="20%" TextAlign="TextAlign.Start" Frozen="true">
            <EditTemplate Context="product">
                <RadzenTextBox @bind-value="@product.name" Style="width: 100%;" />
            </EditTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ProductDto.price)" Title="Kwota" Width="12%" TextAlign="TextAlign.Start" Frozen="true">
            <Template Context="product">
                <div style="color: @(product.settled ? "green" : "red")">
                    <b>@(product.price.ToString(("0.00")))zł</b>
                </div>
            </Template>
            <EditTemplate Context="product">
                <RadzenNumeric @bind-Value="@product.price" Style="width: 100%;" />
            </EditTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ProductDto.maxQuantity)" Title="Ilość osób" Width="8%" TextAlign="TextAlign.Center" Frozen="true">
            <Template Context="product">
                @if (product.divisible)
                {
                    @product.maxQuantity
                }
                else
                {
                    <div>-</div>
                }
            </Template>
            <EditTemplate Context="product">
                @if (product.divisible)
                {
                    <RadzenNumeric @bind-Value="@product.maxQuantity" />
                }
                else
                {
                    <div>-</div>                    
                }
            </EditTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ProductDto.compensationPrice)" Title="Wyrównanie" Width="8%" TextAlign="TextAlign.Center" Frozen="true">
            <Template Context="product">
                @if (product.divisible)
                {
                    @($"{product.compensationPrice.ToString("0.00")}zł")
                }
                else
                {
                    <div>-</div>
                }
            </Template>
            <EditTemplate>
                -
            </EditTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ProductDto.personNames)" Title="Osoby" Width="15%" TextAlign="TextAlign.Center" Frozen="true">
            <Template Context="product">
                @{
                    string buttonText;
                    if (string.IsNullOrEmpty(product.personNames))
                        buttonText = "Osoby";
                    else
                        buttonText = product.personNames;
                }
                <RadzenButton Click="@(async () => { await ManagePerson(product.id); })" Style="width: 100%;">
                    @if (!string.IsNullOrEmpty(product.personNames))
                    {
                        <div style="font-size: 10px;">@((MarkupString)product.personNames)</div>
                    }
                </RadzenButton>
            </Template>
            <EditTemplate Context="product">
                @if (Persons.Count > 0)
                {
                    if (product.divisible && product.id != 0)
                    {
                        <RadzenButton Text="Osoby" Click="@(async () => { await ManagePerson(product.id); })"></RadzenButton>
                    }
                    else if (!product.divisible)
                    {
                        <RadzenDropDownDataGrid TValue="PersonDto"
                                                Value="SelectedPerson"
                                                ValueChanged="OnPersonSet"
                                                Data="@Persons"
                                                TextProperty="@nameof(PersonDto.name)"/>
                    }
                }
            </EditTemplate>
        </RadzenDataGridColumn>

    </Columns>
</RadzenDataGrid>

<style>
    .button {
        width: 36px;
        height: 36px;
    }

    .rz-cell-filter-content {
        display: flex;
        justify-content: center
    }
</style>